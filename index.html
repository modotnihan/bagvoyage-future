<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Bagvoyage</title>

  <!-- Icons / PWA -->
  <link rel="icon" type="image/png" sizes="32x32" href="img/bagvoyage-icon-32.png" />
  <link rel="apple-touch-icon" href="img/bagvoyage-icon-180.png" />
  <link rel="manifest" href="manifest.json" />

  <!-- Theme Colors -->
  <meta name="theme-color" content="#1aa3ff" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <!-- Fonts & ZXing -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />
  <script src="https://unpkg.com/@zxing/browser@latest"></script>

  <!-- App CSS -->
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <!-- Splash -->
  <div id="splash">
    <div class="wrap">
      <img src="img/bagvoyage-icon-192.png" alt="Bagvoyage logo" />
      <h1>Bagvoyage</h1>
    </div>
  </div>

  <!-- Pull-to-refresh indicator -->
  <div id="ptrIndicator" aria-hidden="true">↓ Release to refresh</div>

  <!-- Saved ✓ overlay -->
  <div id="savedTick" class="saved-tick" aria-hidden="true">✔</div>

  <!-- Hidden input for HID barcode scanners (keyboard wedge) -->
  <input id="scannerInput"
         type="text"
         autocomplete="off"
         autocapitalize="off"
         spellcheck="false"
         autofocus
         aria-hidden="true"
         style="position:absolute;left:-9999px;opacity:0;width:1px;height:1px" />

  <div class="app" role="application" aria-label="Bagvoyage">
    <div class="hdr">
      <div class="brand">
        <!-- Simple suitcase + check -->
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <title>Suitcase with checkmark</title>
          <rect x="5" y="7" width="14" height="12" rx="2" ry="2" fill="none" stroke="#1aa3ff" stroke-width="2"/>
          <path d="M9 7V5a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2" fill="none" stroke="#1aa3ff" stroke-width="2"/>
          <path d="M8 13l2.2 2.2L16 9.5" fill="none" stroke="#00cc88" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <span>Bagvoyage</span>
      </div>
      <div class="right">
        <span class="chip"><span id="dbDot" class="dot"></span><span id="dbLabel">DB: checking…</span></span>
        <span class="chip"><span id="camDot" class="dot"></span><span id="camLabel">Camera: idle</span></span>
      </div>
    </div>

    <div id="home" class="main home">
      <div class="stack">
        <button id="btnTag" class="btn primary">Tag — Start scanning</button>
        <button id="btnRetrieve" class="btn ghost">Retrieve — Scan to verify</button>
        <button id="btnManual" class="btn ghost">Manual entry</button>
      </div>
    </div>

    <div id="scan" class="main scan hidden" aria-live="polite">
      <div class="toolbar">
        <div class="title" id="modeTitle">Mode</div>
        <div class="spacer"></div>

        <!-- Hardware Scanner toggle -->
        <button id="btnHID" class="btn ghost" title="Toggle hardware scanner (HID)">Hardware Scanner: Off</button>

        <button id="btnTorch" class="btn ghost" title="Toggle torch" aria-pressed="false" disabled>Torch</button>
        <button id="btnStop" class="btn ghost" title="Exit scanning">Exit</button>
      </div>

      <video id="preview" muted playsinline webkit-playsinline
             aria-label="Camera feed for barcode scanning"></video>

      <div class="frame" aria-hidden="true">
        <div class="corn tl"></div><div class="corn tr"></div><div class="corn bl"></div><div class="corn br"></div>
        <div class="line"></div>
      </div>

      <!-- Result sheet (singleton) -->
      <div id="sheet" class="sheet" aria-atomic="true" role="alert">
        <div class="row">
          <span id="pill" class="pill">STATE</span>
          <button id="btnContinue" class="btn primary hidden">Continue</button>
        </div>
        <div id="sheetTitle" class="sheet-title">Result</div>
        <div id="sheetCode" class="sheet-code" aria-live="polite"></div>
      </div>

      <!-- toast -->
      <div id="toast" class="toast" role="status" aria-live="polite">Saved</div>
    </div>
  </div>

  <!-- Manual entry -->
  <dialog id="manualDialog" aria-labelledby="manualTitle">
    <form method="dialog">
      <div id="manualTitle" class="modal-title">Manual entry</div>
      <label for="manualInput" class="sr-only">Enter baggage code</label>
      <input id="manualInput" type="text" placeholder="Enter code" aria-describedby="manualDesc"/>
      <div id="manualDesc" class="sr-only">Enter a 10 or 13-digit baggage code.</div>
      <div class="modal-actions">
        <button class="btn ghost" value="cancel">Cancel</button>
        <button id="manualApply" class="btn primary" value="ok">Apply</button>
      </div>
    </form>
  </dialog>

  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>

  <!-- Firebase init -->
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAGIsT39wSCmFdygWtVe-u1DIPo06OTWko",
      authDomain: "bagvoyage-future.firebaseapp.com",
      projectId: "bagvoyage-future",
      storageBucket: "bagvoyage-future.appspot.com",
      messagingSenderId: "966888670918",
      appId: "1:966888670918:web:cb61491c8ee5e85377f9c7",
      measurementId: "G-BNENF85XLE"
    };
    firebase.initializeApp(firebaseConfig);

    // Firestore settings (Safari-friendly) + offline cache
    const fs = firebase.firestore();
    fs.settings({
      experimentalAutoDetectLongPolling: true,
      useFetchStreams: false
    });
    fs.enablePersistence({ synchronizeTabs: true }).catch(()=>{});
  </script>

  <!-- GLOBAL session helper (defines window.BV) -->
  <script>
    window.BV = (function(){
      const db = firebase.firestore(), auth = firebase.auth();

      function sessionDocId(){ return 'global'; }

      async function signInAnon(){
        if (!auth.currentUser) await auth.signInAnonymously();
        return auth.currentUser;
      }
      async function ensureSession(){
        const id = sessionDocId();
        await db.collection('sessions').doc(id).set({
          label: 'global',
          created_at: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });
        return id;
      }
      async function saveTagServer(sessionId, code, source='camera'){
        if (!sessionId || !code) return;
        await db.collection('sessions').doc(sessionId).collection('tags')
          .doc(code).set({
            code, source,
            created_at: firebase.firestore.FieldValue.serverTimestamp()
          }, { merge:true });
      }
      async function existsServer(sessionId, code){
        if (!sessionId || !code) return false;
        const snap = await db.collection('sessions').doc(sessionId)
          .collection('tags').doc(code).get();
        return snap.exists;
      }
      function subscribeTags(sessionId, onAdd){
        return db.collection('sessions').doc(sessionId).collection('tags')
          .orderBy('created_at','desc').limit(200)
          .onSnapshot(s => s.docChanges().forEach(ch => {
            if (ch.type === 'added') onAdd && onAdd(ch.doc.id);
          }));
      }
      async function logScan(sessionId, code, matched){
        if (!sessionId) return;
        await db.collection('sessions').doc(sessionId).collection('scans').add({
          code, matched: !!matched, ua: navigator.userAgent.slice(0,120),
          created_at: firebase.firestore.FieldValue.serverTimestamp()
        });
      }

      return { signInAnon, ensureSession, saveTagServer, existsServer, subscribeTags, logScan };
    })();
  </script>

  <!-- Your app logic (uses BV) -->
  <script src="app.js"></script>
</body>
</html>
